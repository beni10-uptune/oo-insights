rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isActive() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.active == true;
    }
    
    // User profiles collection
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      allow read: if isOwner(userId) || isAdmin();
      
      // Only admins can create new user profiles
      allow create: if isAdmin() || (!exists(/databases/$(database)/documents/users/$(request.auth.uid)));
      
      // Only admins can update user profiles
      allow update: if isAdmin();
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // Settings collection (if needed for app settings)
    match /settings/{document=**} {
      allow read: if isAuthenticated() && isActive();
      allow write: if isAdmin();
    }
    
    // Market data collection (example for market-specific content)
    match /markets/{market} {
      allow read: if isAuthenticated() && isActive() && (
        hasRole('ADMIN') || 
        hasRole('TEAM_EUCAN') ||
        (hasRole('TEAM_LOCAL') && 
          market in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.markets)
      );
      allow write: if isAdmin() || hasRole('TEAM_EUCAN');
    }
    
    // Audit logs (write-only for all authenticated, read for admins)
    match /audit/{document=**} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if false; // Audit logs should never be updated
      allow delete: if false; // Audit logs should never be deleted
    }
  }
}